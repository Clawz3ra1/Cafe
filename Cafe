-- Criando a UI
local player = game.Players.LocalPlayer
local gui = Instance.new("ScreenGui")
gui.Parent = player:WaitForChild("PlayerGui")

gui.ResetOnSpawn = false

local button = Instance.new("TextButton")
button.Size = UDim2.new(0, 150, 0, 50)
button.Position = UDim2.new(0.05, 0, 0.1, 0)
button.Text = "Ativar ESP"
button.Parent = gui
button.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
button.TextColor3 = Color3.fromRGB(255, 255, 255)
button.Font = Enum.Font.SourceSansBold
button.TextSize = 18
button.BorderSizePixel = 2
button.BorderColor3 = Color3.fromRGB(255, 0, 0)

local espEnabled = false

local function createESP(player)
    if player.Character and player.Character:FindFirstChild("HumanoidRootPart") then
        local billboard = Instance.new("BillboardGui")
        billboard.Adornee = player.Character.HumanoidRootPart
        billboard.Size = UDim2.new(4, 0, 6, 0)
        billboard.StudsOffset = Vector3.new(0, 2, 0)
        billboard.AlwaysOnTop = true
        
        local frame = Instance.new("Frame", billboard)
        frame.Size = UDim2.new(1, 0, 1, 0)
        frame.BackgroundTransparency = 0.5
        frame.BackgroundColor3 = Color3.fromRGB(255, 0, 0)
        
        billboard.Parent = player.Character
        
        -- Criando o Highlight
        local highlight = Instance.new("Highlight")
        highlight.Parent = player.Character
        highlight.FillColor = Color3.fromRGB(255, 0, 0)
        highlight.OutlineColor = Color3.fromRGB(255, 255, 255)
        highlight.FillTransparency = 0.5
        highlight.OutlineTransparency = 0
        
        -- Criando a linha
        local line = Instance.new("Part")
        line.Size = Vector3.new(0.1, 0.1, 0.1)
        line.Anchored = true
        line.CanCollide = false
        line.Color = Color3.fromRGB(255, 0, 0)
        line.Material = Enum.Material.Neon
        line.Parent = game.Workspace
        
        game:GetService("RunService").RenderStepped:Connect(function()
            if espEnabled and player.Character and player.Character:FindFirstChild("HumanoidRootPart") and game.Players.LocalPlayer.Character and game.Players.LocalPlayer.Character:FindFirstChild("HumanoidRootPart") then
                local startPos = game.Players.LocalPlayer.Character.HumanoidRootPart.Position
                local endPos = player.Character.HumanoidRootPart.Position
                local direction = (endPos - startPos)
                local distance = direction.Magnitude
                
                -- Atualizando a linha
                line.Size = Vector3.new(0.1, 0.1, distance) -- Tamanho correto baseado na distância
                line.Position = startPos + direction / 2 -- Posição no meio do caminho
                line.CFrame = CFrame.new(startPos, endPos) -- Ajuste do CFrame para garantir que a linha aponte para o jogador alvo
            else
                line:Destroy()
            end
        end)
    end
end

local function toggleESP()
    espEnabled = not espEnabled
    button.Text = espEnabled and "Desativar ESP" or "Ativar ESP"
    
    for _, player in pairs(game.Players:GetPlayers()) do
        if player ~= game.Players.LocalPlayer then
            if espEnabled then
                createESP(player)
            else
                if player.Character then
                    for _, v in pairs(player.Character:GetChildren()) do
                        if v:IsA("BillboardGui") or v:IsA("Highlight") or v:IsA("Part") then
                            v:Destroy()
                        end
                    end
                end
            end
        end
    end
end

button.MouseButton1Click:Connect(toggleESP)

game.Players.PlayerAdded:Connect(function(player)
    player.CharacterAdded:Connect(function()
        if espEnabled then
            task.wait(1) -- Pequeno delay para garantir que o personagem carregue
            createESP(player)
        end
    end)
end)
